function     [A,M,t,p,mbb] = gomcal(s,tagrun)
%
%     [A,M,t,p,mbb] = gomcal(s,tagrun)
%     Sperm whale Gulf of Mexico data set 2001.
%     Correct accelerometer, magnetometer, temperature and 
%     pressure time series for offset and scale.
%       s is the raw sensor matrix from readsen2b()
%       tagrun is the name of the deployment e.g., 'sw01_200'
%       A is the corrected accelerometer signals, A=[ax,ay,az],
%            The units are g.
%       M is the corrected magnetometer signals, M=[mx,my,mz],
%            The units are Gauss.
%       t is the corrected temperature signal in Celcius.
%       p is the corrected pressure signal in m water depth.
%       mbb is the magnetometer bridge signal.
%
%     Output sampling rate is the same as the input sampling rate.
%     Note that the t and p corrections are based on ad-hoc values
%     and will change as better calibrations are available.
%
%     DTAG V1.2 Script Set
%     mark johnson and patrick miller, WHOI
%     July-August 2001

switch tagrun
   case 'sw01_200'
      % sw01_200 used tag #6, 32kHz sampling
   	p_cal = [449 1.47 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1892.65 700.5 0.07e-3 -0.045;
              1938.76 677.5 0.089e-3 -0.061;
              1946.78 681.5 -0.3e-3 0] ;
      a_cal = [1892.65 700.5 0.0e-3 0.0;
              1938.76 677.5 0.0e-3 0.0;
              1946.78 681.5 0.0e-3 0] ;
      m_cal = [2264.13 372.36;
               1957.05 460.61;
               2060.6 649.44] ;
      x_cal = [-0.36e-3 1 0 -0.05;
               -2.43e-3 0 1 0;
               1.06e-3 -0.13 0 1] ;
   case 'sw01_204'
      % sw01_204 used tag #6, 32kHz sampling
   	p_cal = [449 1.47 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1891 700.5;
              1938.76 677.5;
              1946.78 681.5] ;
      ax_cal = [0.057e-3 0 1 0 -0.05;
              0.034e-3 0 0 1 -0.057;
              -0.241e-3 0 0 0 1] ;
      m_cal = [2265 362.61;
               1944 448.49;
               2059.8 619.93] ;
      mx_cal = [0 1 -0.01 -0.095;
               -2.6e-3 -0.014 1 0.026;
               1e-3 -0.09 0.005 1] ;
   case 'sw01_208b'
      % sw01_208b used tag #6, 32kHz sampling
   	p_cal = [449 1.47 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1905 700.5;
              1938.76 677.5;
              1946.78 681.5] ;
      ax_cal = [0.07e-3 0 1 -0.03 -0.02;
              0 0 0 1 -0.058;
              -0.23e-3 0 0 0 1] ;
      m_cal = [2288.6 362.61;
               1974.1 448.49;
               2007.9 619.93] ;
      mx_cal = [0.13e-3 1 -0.01 -0.095;
               -2.16e-3 -0.02 1 0.038;
               0.647e-3 -0.09 0.015 1] ;
   case 'sw01_209c'
      % sw01_209c used tag #6, 32kHz sampling
   	p_cal = [449 1.47 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1905 700.5;
              1932 677.5;
              1937.2 681.5] ;
      ax_cal = [0.11e-3 0 1 0 -0.054;
              0.07e-3 0 0 1 -0.057;
              -0.33e-3 0 0 0 1] ;
      m_cal = [2262.2 362.61;
               1929.3 448.49;
               2066.6 619.93] ;
      mx_cal = [-0.3e-3 1 0 -0.095;
               -2.8e-3 -0.02 1 0;
               1e-3 -0.09 0.015 1] ;

   case 'sw01_265'
      % sw01_265 used tag #9, 32kHz sampling
   	p_cal = [444 1.47 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2031.3 728.8;
              1824.8 726.2;
              964.3 718.1] ;
      ax_cal = [0.025e-3 0.013 1 0.007 -0.08;
              -0.056e-3 0 0 1 -0.02;
              -0.39e-3 -0.02 -0.016 0 1] ;
      m_cal = [2189.8 8.626;
               1861.6 9.976;
               2056.5 11.935] ;
      mx_cal = [-0.042 1 0 -0.06;
               -0.102 0 1 0;
               0.163 -0.055 0 1] ;
      k = [2850:17100 20600:36500 40540:55000 58850:72740] ;
            
   case 'sw01_275b'
      % sw01_275b used tag #9, 32kHz sampling
   	p_cal = [444 1.47 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2031.3 728.8;
              1824.8 726.2;
              964.3 718.1] ;
      ax_cal = [0.025e-3 0.013 1.05 0.007 -0.08;
              -0.056e-3 0 0 1.05 -0.02;
              -0.39e-3 -0.02 -0.016 0 1.05] ;
      m_cal = [2126.9-15.3 8.626;
               1911.6-29 9.976;
               2090.1+39.4 11.935] ;
      mx_cal = [-0.042 1 0 -0.06;
               -0.102 0 1 0;
               0.163 -0.055 0 1] ;
      k = [92:10689 14376:29395 33027:48413 52166:68975 72835:87358 ...
           91253:104730 108448:122956 126447:140610] ;

   case 'pw02_091c'
      % pw02_091c used tag #10, 32kHz sampling
   	p_cal = [427 3 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2261.2 685.7;
              1962 692.6;
              1887.8 669.3] ;
      ax_cal = [0 0 1 0 0;
              -0.035e-3 0 0 1 0;
              -0.24e-3 0 0 0 1] ;
      m_cal = [2083-8.9 10.92;
               2183.5-11.4 10.35;
               1918.8-11 11.7] ;
      mx_cal = [0 1 0 0;
               0 0 1 0;
               0 0 0 1] ;
            
    case 'pw02_091b'
      % pw02_091b used tag #8, 32kHz sampling
   	p_cal = [429.5 1.47 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1840.37 349.82; %Patio's screwup
              1879.8 342.69;
              1899.89 336.04] ;
      ax_cal = [0 0 1 0 0;
              0 0 0 1 0;
              0 0 0 -0.1171 1] ;
      a_cal = [1854 368;%Mark's numbers from span8
              1897.5 360.5;
              1888.5 353.5] ;
      ax_cal = [0 0 1 0 0;
              0 0 -.01 1 0;
              0 0 -.03 -0.02 1] ;
      m_cal = [2284.27 8.246;
               1977.53 9.558;
               1964.67 10.697] ;
      mx_cal = [0 1 0 0;
               0 0 1 0;
               0 -0.091 0.037 1] ;
      k=1:94911;
            
   case 'sw02_191b'
      % sw02_191b used tag #10, 32kHz sampling
   	p_cal = [427 1.731 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9 697;
              1974.8 706.5;
              1886.1 683.3] ;
      ax_cal = [2e-5 -5.4e-3 1 0 0;
              -8.4e-5 -5.1e-3 0 1 0;
              -2.42e-4 -1e-3 0 0 1] ;
      m_cal = [2084.6 11.777;
               2211.2 10.67;
               1936.6 12.144] ;
      mx_cal = [-0.008 1 0 0;
               0.04 0 1 0;
               -0.026 0 0.015 1] ;

   case 'sw02_235c'
      % sw02_235c used tag #10, 32kHz sampling
   	p_cal = [424.6 1.731 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9-1 697;
              1974.8-4 706.5;
              1886.1-10 683.3] ;
      ax_cal = [2e-5 -7.1e-3 1 0 0;
              -8.4e-5 -7.5e-3 0 1 0;
              -2.42e-4 -1e-3 0 0 1] ;
      m_cal = [2058.1+27.1 11.777;
               2184.1+31.2 10.67;
               1923.3+24.7 12.144] ;
      mx_cal = [0.037 1 0 0;
               0.028 0 1 0;
               0.02 0 0.015 1] ;

   case 'sw02_237a'
      % sw02_237a used tag #10, 32kHz sampling
   	p_cal = [424.6 1.731 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9+9.6 697;
              1974.8+1 706.5;
              1886.1-19.1 683.3] ;
      ax_cal = [2e-5 -7.1e-3 1 0 0;
              -8.4e-5 -7.5e-3 0 1 0;
              -2.42e-4 -1e-3 0 0 1] ;
      m_cal = [2103.8-30 11.777;
               2133+50.1 10.67;
               1919.1+15.9 12.144] ;
      mx_cal = [0.034 1 0 0;
               0.039 0 1 0;
               0.024 0 0.015 1] ;
		k = 2e4:8.8e4 ;

   case 'sw02_238a'
      % sw02_238a used tag #10, 32kHz sampling
   	p_cal = [424.6 1.731 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9+9.6 697;
              1974.8+1 706.5;
              1886.1-19.1 683.3] ;
      ax_cal = [2e-5 -7.1e-3 1 0 0;
              -8.4e-5 -7.5e-3 0 1 0;
              -2.42e-4 -1e-3 0 0 1] ;
      m_cal = [2074.1+13.1 11.777;
               2150.4+27.6 10.67;
               1923.9+19.6 12.144] ;
      mx_cal = [0.006-0.9e-3 1 0 0;
               0.029+3.2e-3 0 1 0;
               0.03-5.7e-3 0 0.015 1] ;
		k = 3950:1e5 ;

   case 'sw02_238b'
      % sw02_238b used tag #12, 32kHz sampling
   	p_cal = [423 1.62 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4 694.9;
              1876.4 725.6;
              1936.8 695.5] ;
      ax_cal = [2.7e-4 0 1 0 0;
                -1.2e-4 0 0 1 0;
                -9e-5 0 0 0 1] ;
      m_cal = [2074.1+409+0.2 11.58;
               2150.4-194-0.2 10.67;
               1923.9-10.1 11.86] ;
      mx_cal = [0.022 1 0 0;
               0.025 0 1 0;
               0.05 -0.02 -0.034 1] ;
		k = [1:1.32e4 1.36e4:4.45e4] ;

   case 'sw02_239a'
      % sw02_239a used tag #10, 32kHz sampling
   	p_cal = [424.6 1.731 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9+7 697;
              1974.8-14.8 706.5;
              1886.1-23.2 683.3] ;
      ax_cal = [2e-5 -5.4e-3 1 0 0;
              -8.4e-5 -5.1e-3 0 1 0;
              -2.42e-4 -1e-3 0 0 1] ;
      m_cal = [2073.3+21.93 11.777;
               2179.1+26.67 10.67;
               1942.1+12.42 12.144] ;
      mx_cal = [0.006 1 0 0;
               0.029 0 1 0;
               0.03 0 0.015 1] ;

   case 'sw02_239b'
      % sw02_239b used tag #12, 32kHz sampling
   	p_cal = [423 1.62 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4-4.2 694.9;
              1876.4+3.6 725.6;
              1936.8-28.5 695.5] ;
      ax_cal = [2.7e-4 0 1 0 0;
                -1.2e-4 0 0 1 0;
                -1.6e-4 0 0 0 1] ;
      m_cal = [2464.3+14.2 11.58;
               1913.3+18.8 10.67;
               1884.8+8.3 11.86] ;
      mx_cal = [0.012 1 0 0;
               0.033 0 1 0;
               0.045 -0.02 -0.034 1] ;
		k = 1:1.85e4 ;

   case 'sw02_240a'
      % sw02_240a used tag #12, 32kHz sampling
   	p_cal = [423 1.62 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4-70.9 694.9;
              1876.4-13 725.6;
              1936.8-23 695.5] ;
      ax_cal = [2.7e-4 0 1 0 0;
                -1.2e-4 0 0 1 0;
                -1.6e-4 0 0 0 1] ;
      m_cal = [2472.8-1.2 11.58;
               1914.8+14.9 10.67;
               1894+1.2 11.86] ;
      mx_cal = [0.012 1 0 0;
               0.033 0 1 0;
               0.045 -0.02 -0.034 1] ;
		k = 1:1.51e4 ;

   case 'sw02_240c'
      % sw02_240c used tag #10, 32kHz sampling
   	p_cal = [424.6 1.731 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9+7 697;
              1974.8-14.8 706.5;
              1886.1-23.2 683.3] ;
      ax_cal = [2e-5 -5.4e-3 1 0 0;
              -8.4e-5 -5.1e-3 0 1 0;
              -2.42e-4 -1e-3 0 0 1] ;
      m_cal = [2086.9+8 11.777;
               2195.5+11 10.67;
               1948.5+3.4 12.144] ;
      mx_cal = [0.006 1 0 0;
               0.029 0 1 0;
               0.03 0 0.015 1] ;
		k = [2000:2.03e4 2.055e4:11.14e4] ;

   case 'sw02_248a'
      % sw02_248a used tag #10, 32kHz sampling
   	p_cal = [424.6 1.731 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9+4 697;
              1974.8-12.7 706.5;
              1886.1-14.3 683.3] ;
      ax_cal = [2e-5 -5.4e-3 1 0 0;
              -8.4e-5 -5.1e-3 0 1 0;
              -2.42e-4 -1e-3 0 0 1] ;
      m_cal = [2080.9+14.1 11.777;
               2162.6+25 10.67;
               1920.9+26.8 12.144] ;
      mx_cal = [0.006 1 0 0;
               0.029 0 1 0;
               0.03 0 0.015 1] ;
		k = 8420:26950 ;

   case 'sw02_249a'
      % sw02_249a used tag #12, 32kHz sampling
   	p_cal = [423 1.62 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4-5.6 694.9;
              1876.4+6.6 725.6;
              1936.8-48.9 695.5] ;
      ax_cal = [2.7e-4 0 1 0 0;
                -1.2e-4 0 0 1 0;
                -1.6e-4 0 0 0 1] ;
      m_cal = [2464.8+11.4 11.58;
               1923.5+24.5 10.67;
               1876.3+29.4 11.86] ;
      mx_cal = [0.012 1 0 0;
               0.033 0 1 0;
               0.045 -0.02 -0.034 1] ;
		k = 1:4e4 ;

   case 'sw02_253a'
      % sw02_253a used tag #12, 32kHz sampling
   	p_cal = [421.3 1.62 -0.045] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962-18.6 694.9;
              1876+13.3 725.6;
              1937-46.6 695.5] ;
      ax_cal = [2.7e-4 0 1 0 0;
                -1.2e-4 0 0 1 0;
                -1.6e-4 0 0 0 1] ;
      m_cal = [2424.5+3.5 11.58;
               1870.3+18.1 10.67;
               1903.6+17.8 11.86] ;
      mx_cal = [0.012 1 0 0;
               0.033 0 1 0;
               0.045 -0.02 -0.034 1] ;
		k = 1:8.6e4 ;

   case 'sw02_254a'
      % sw02_254a used tag #10, 32kHz sampling
   	p_cal = [423.5 1.731 -0.01] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [2262.9+11 697;
              1974.8-3.7 706.5;
              1886.1-22.8 683.3] ;
      ax_cal = [2e-5 -8e-3 1 0 0;
              -8.4e-5 -7.6e-3 0 1 0;
              -2.42e-4 -0.8e-3 0 0 1] ;
      m_cal = [2078.4+14.4+0.8 11.777;
               2175.4+17.3+0.4 10.67;
               1944.9+18-0.5 12.144] ;
      mx_cal = [-0.001 1 0 0;
               0.036 0 1 0;
               0.026 0 0.015 1] ;

   case 'sw02_254b'
      % sw02_254b used tag #12, 32kHz sampling
  	   p_cal = [421 1.62 -0.045] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4-0.7 694.9;
              1876.4+12.4 725.6;
              1936.8-51.7 695.5] ;
      ax_cal = [2.7e-4 -3e-4 1 0 0;
                -1.2e-4 -1e-3 0 1 0;
                -1.6e-4 0 0 0 1] ;
      m_cal = [2449.9-3.8 11.58;
               1868.8+32.1 10.67;
               1901.6+16.8 11.86] ;
      mx_cal = [0.003 1 0 0;
               0.023 0 1 0;
               0.045 -0.02 -0.034 1] ;

   case 'sw02_254c'
      % sw02_254c used tag #11, 32kHz sampling
   	p_cal = [438 1.656 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1935.7+29.9 729.9;
              1964.8+7.1 704.9;
              2115.5-27.3 690.7] ;
      ax_cal = [2e-4 -1.3e-3 1 0 0;
              -0.4e-4 -4e-4 0 1 0;
              -3.1e-4 1e-4 0 0 1] ;
      m_cal = [1847.9+3.3 11.55;
               2113.5+33.8 10.93;
               2288.8-45.8 12.37] ;
      mx_cal = [0 1 0 0;
               0.02 0 1 0;
               -0.08 0 0 1] ;
           
    case 'tag11'
      % generic tag #11, 32kHz sampling
   	p_cal = [438 1.656 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1935.7-37.3 729.9;
              1964.8-36.5 704.9;
              2115.5-20 690.7] ;
      ax_cal = [2e-4 -1.3e-3 1 0 0;
              -0.4e-4 -4e-4 0 1 0;
              -3.1e-4 1e-4 0 0 1] ;
      m_cal = [1847.9+3.3 11.55;
               2113.5+33.8 10.93;
               2288.8-45.8 12.37] ;
      mx_cal = [0 1 0 0;
               0.02 0 1 0;
               -0.08 0 0 1] ;

   case 'pw03_074a'
      % pw03_074a used tag #11, 64kHz sampling
  	  p_cal = [435.5 1.656 0] ;
   	  t_cal = [3800 -63.3] ;
      a_cal = [1962.4+18.2 694.9;
              1876.4+141.6 725.6;
              1936.8+137 695.5] ;
      ax_cal = [0.7e-4 -3e-4 1 0 0;
                -0.5e-4 -1e-3 0 1 0;
                -2.6e-4 0 0 0 1] ;
      m_cal = [1815.3+25.9 10.73;
               2096+10.1 9.89;
               2261.9-16.9 11] ;
      mx_cal = [0.008 1 0 0;
               0.072 0 1 0;
               -0.1 -0.02 -0.034 1] ;
	   k = 1:4e4 ;

   case 'pw03_076a'
      % pw03_076a used tag #11, 64kHz sampling
  	   p_cal = [435.5 1.656 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4+18.2-23.3 694.9;
              1876.4+141.6-27.5 725.6;
              1936.8+137+13.7 695.5] ;
      ax_cal = [0.7e-4 -3e-4 1 0 0;
                -0.5e-4 -1e-3 0 1 0;
                -2.6e-4 0 0 0 1] ;
      m_cal = [1794.6+23.2-1.2 10.38;
               2109.1-16.8+1.6 10.05;
               2261.1-7.1-0.6 11.18] ;
      mx_cal = [0.67 1 0 0;
               0.1 -0.03 1 0;
               -0.67 0 -0.034 1] ;
	   k = 3e4:5.3e4 ;
          
   case 'pw03_076b'
      % pw03_076b used tag #13, 64kHz sampling
   	p_cal = [420 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      m_cal = [2385.1 11.55;
               2090.1 10.93;
               1822 12.37] ;
      mx_cal = [0 1 0 0;
               0.02 0 1 0;
               -0.08 0 0 1] ;
      a_cal = [1858.7-14.7 627.7;
              1960.7-12.9 619.4;
              1923.8+4.7 716.9] ;
      ax_cal = [1.1e-4 -1.3e-3 1 0 0;
              -1.4e-4 -4e-4 0 1 0;
              -2.8e-4 1e-4 0 0 1] ;
      m_cal = [2369.6-3.1 8.35;
               2094.2-6.8 9.58;
               1857.6+14.6 10.75] ;
      mx_cal = [0.04 1 0 -0.02;
               -0.06 0 1 0.05;
               -0.02 0 0 1] ;
      k = [3e4:3.18e4,3.35e4:3.48e4,3.87e4:3.95e4,6.22e4:6.73e4,7e4:7.57e4] ;

   case 'pw03_077a'
      % pw03_077a used tag #11, 32kHz sampling
  	   p_cal = [435.5 1.656 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4+18.2 694.9;
              1876.4+141.6 725.6;
              1936.8+137 695.5] ;
      ax_cal = [0.7e-4 -3e-4 1 0 0;
                -0.5e-4 -1e-3 0 1 0;
                -2.6e-4 0 0 0 1] ;
      m_cal = [1826.1-6.5 10.73;
               2131.8-38 9.89;
               2224.6+22.5 11] ;
      mx_cal = [-0.03 1 0 0;
               -0.03 0 1 0;
               -0.02 -0.02 -0.034 1] ;
	   k = 1:1.84e4 ;
          
   case 'pw03_077b'
      % pw03_077b used tag #13, 32kHz sampling
   	p_cal = [420 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1858.7-5.4 627.7;
              1960.7-6.7 619.4;
              1923.8+11.2 716.9] ;
      ax_cal = [-0.6e-4 -1.3e-3 1 0 0;
              -1.9e-4 -4e-4 0 1 0;
              -1.2e-4 1e-4 0 0 1] ;
      m_cal = [2368.6-5.2 8.35;
               2070.7+20.6 9.58;
               1880-9.5 10.75] ;
      mx_cal = [0 1 0 -0.03;
               -0.1 0 1 0.01;
               0 0 0 1] ;
      k = 1:1.35e5 ;

   case 'pw03_078a'
      % pw03_078a used tag #11, 32kHz sampling
  	   p_cal = [435.5 1.656 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4-116.7 694.9;
              1876.4+41.7 725.6;
              1936.8+121.5 695.5] ;
      ax_cal = [0.5e-4 -3e-4 1 0 0;
                -0.4e-4 -1e-3 0 1 0;
                -2.6e-4 0 0 0 1] ;
      %m_cal = [1812.4+21.1 10.73;
      %         2086+11.6 9.89;
      %         2277.8-39.8 11] ;
      m_cal = [1812.4+14.2 10.8;
               2086+24.9 10.05;
               2277.8-55.4 11.18] ;
      mx_cal = [0.06 1 0 0;
               0.04 -0.05 1 0;
               -0.06 0.02 -0.034 1] ;
	   k = [950:0.6e4 1.65e4:2.656e4 2.703e4:2.935e4 4.6e4:5.4e4] ;

   case 'pw03_078b'
      % pw03_078b used tag #13, 64kHz sampling
   	p_cal = [420 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1858.7-5.4 627.7;
              1960.7-6.7 619.4;
              1923.8+11.2 716.9] ;
      ax_cal = [-0.6e-4 -1.3e-3 1 0 0;
              -1.9e-4 -4e-4 0 1 0;
              -1.2e-4 1e-4 0 0 1] ;
      m_cal = [2386.5+25.4 11.55;
               2079+9.5 10.93;
               1844+32.4 12.37] ;
      m_cal = [2386.7-1.5 8.35;
               2084.8+0.8 9.58;
               1877-12 10.75] ;
      mx_cal = [0.05 1 0 -0.03;
               -0.15 0 1 0.01;
               0.24 0 0 1] ;
         
   case 'pw03_082a'
      % pw03_082a used tag #11, 32kHz sampling
  	   p_cal = [435.5 1.656 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4-116.7 694.9;
              1876.4+41.7 725.6;
              1936.8+121.5 695.5] ;
      ax_cal = [0.5e-4 -3e-4 1 0 0;
                -0.4e-4 -1e-3 0 1 0;
                -2.6e-4 0 0 0 1] ;
      %m_cal = [1812.4+21.1 10.73;
      %         2086+11.6 9.89;
      %         2277.8-39.8 11] ;
      m_cal = [1812.4+14.2 10.8;
               2086+24.9 10.05;
               2277.8-55.4 11.18] ;
      mx_cal = [0.06 1 0 0;
               0.04 -0.05 1 0;
               -0.06 0.02 -0.034 1] ;
	   %k = [950:0.6e4 1.65e4:2.656e4 2.703e4:2.935e4 4.6e4:5.4e4] ;

  case 'pw03_082b'
      % pw03_082b used tag #13, 48kHz sampling
   	p_cal = [420 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1858.7-5.4 627.7;
              1960.7-6.7 619.4;
              1923.8+11.2 716.9] ;
      ax_cal = [-0.6e-4 -1.3e-3 1 0 0;
              -1.9e-4 -4e-4 0 1 0;
              -1.2e-4 1e-4 0 0 1] ;
      m_cal = [2386.5+25.4 11.55;
               2079+9.5 10.93;
               1844+32.4 12.37] ;
      m_cal = [2386.7-1.5 8.35;
               2084.8+0.8 9.58;
               1877-12 10.75] ;
      mx_cal = [0.05 1 0 -0.03;
               -0.15 0 1 0.01;
               0.24 0 0 1] ;

   case 'pw03_082c'
      % pw03_082c used tag #13, 48kHz sampling
		% improved 4/19/03
   	p_cal = [420 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1858.7-15.8 627.7;
              1960.7-12.3 619.4;
              1923.8+13.5 716.9] ;
      ax_cal = [1.1e-4 -1.3e-3 1 0 0;
              -1.2e-4 -4e-4 0 1 0;
              -2e-4 1e-4 0 0 1] ;
      m_cal = [2386.7-19.7 8.35;
               2084.8+17.9 9.58;
               1877-12+15.2 10.75] ;
      mx_cal = [0 1 0 -0.04;
               -0.1 0 1 -0.03;
               0 0 0 1] ;
     k = 8850:23600 ;
          
   case 'pw03_082d'
      % pw03_082d used tag #11, 32kHz sampling
  	   p_cal = [435.5 1.656 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1962.4-116.7 694.9;
              1876.4+41.7 725.6;
              1936.8+121.5 695.5] ;
      ax_cal = [0.5e-4 -3e-4 1 0 0;
                -0.4e-4 -1e-3 0 1 0;
                -2.6e-4 0 0 0 1] ;
      %m_cal = [1812.4+21.1 10.73;
      %         2086+11.6 9.89;
      %         2277.8-39.8 11] ;
      m_cal = [1812.4+14.2 10.8;
               2086+24.9 10.05;
               2277.8-55.4 11.18] ;
      mx_cal = [0.06 1 0 0;
               0.04 -0.05 1 0;
               -0.06 0.02 -0.034 1] ;
	   %k = [950:0.6e4 1.65e4:2.656e4 2.703e4:2.935e4 4.6e4:5.4e4] ;

 case 'pw03_082e'
      % pw03_082e used tag #13, 48kHz sampling
   	p_cal = [420 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1858.7-5.4 627.7;
              1960.7-6.7 619.4;
              1923.8+11.2 716.9] ;
      ax_cal = [-0.6e-4 -1.3e-3 1 0 0;
              -1.9e-4 -4e-4 0 1 0;
              -1.2e-4 1e-4 0 0 1] ;
      m_cal = [2386.5+25.4 11.55;
               2079+9.5 10.93;
               1844+32.4 12.37] ;
      m_cal = [2386.7-1.5 8.35;
               2084.8+0.8 9.58;
               1877-12 10.75] ;
      mx_cal = [0.05 1 0 -0.03;
               -0.15 0 1 0.01;
               0.24 0 0 1] ;
           
   case 'sw03_156a'
      % GOM'03, tag #13, 32kHz
      p_cal = [423.4 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1858.7+22.4 627.7;
              1960.7-6.2 619.4;
              1923.8-31.9 716.9] ;
      ax_cal = [0.24e-3 0 1 0 0;
              -0.09e-3 0 -0.03 1 0;
              -0.20e-3 0 0.05 0 1] ;
      m_cal = [2376-6.9 8.35;
               2111-35.6 9.58;
               1919+7 10.75] ;
      mx_cal = [0.05 1 0 0;
               -0.03 0 1 0;
               -0.11 0 0 1] ;
      k = 1:1e5 ;

   case 'tag13'
      % generic tag 13 from pspan, aspan, mspan
      p_cal = [423.4 1.7044 0] ;
   	t_cal = [3800 -63.3] ;
      a_cal = [1858.7 627.7;
              1960.7 619.4;
              1923.8 716.9] ;
      ax_cal = [2e-4 -1.3e-3 1 0 0;
              -0.4e-4 -4e-4 0 1 0;
              -3.1e-4 1e-4 0 0 1] ;
      m_cal = [1847.9-357.7-75.8 11.55;
               2113.5+108.6 10.93;
               2288.8-461 12.37] ;
      m_cal = [2386.7-1.5-693 8.35;
               2084.8+0.8+125 9.58;
               1877-12-35 10.75] ;
      mx_cal = [0 1 0 0;
               0.02 0 1 0;
               -0.08 0 0 1] ;

  otherwise
      fprintf('Unknown experiment - supported experiments are:\n') ;
      fprintf('  sw01_200, sw01_204, sw01_208b\n') ;
      A = []; t = []; p = [] ;
      return ;
end

if exist('k') ~= 1
   k = 1:length(s) ;
end

% clean up temperature and pressure

h = fir1(60,0.2);   % low-pass filter

fprintf('Correcting temperature...\n') ;
t = filtfilt(h,[1 0],(s(:,10)-t_cal(1))/t_cal(2)) ;

fprintf('Pressure bridge...\n') ;
pb = (filtfilt(h,[1 0],s(:,15)-mean(s(:,15)))) ;

fprintf('Correcting pressure...\n') ;
p = filtfilt(h,[1 0],(s(:,11)-p_cal(1))/p_cal(2))+p_cal(3)*pb ;

fprintf('Magnetometer bridge...\n') ;
mbb = (filtfilt(h,[1 0],s(:,14)-mean(s(:,14)))) ;

% calibrate accelerometers for pressure and z-cross-term effects

fprintf('Computing accelerations...\n') ;
%ax = ((s(:,3))-a_cal(1,1))/a_cal(1,2) + p*a_cal(1,3) + a_cal(1,4)*(s(:,5)-1958.5)/681.5;
%ay = ((s(:,4))-a_cal(2,1))/a_cal(2,2) + p*a_cal(2,3) + a_cal(2,4)*(s(:,5)-1958.5)/681.5;
%az = ((s(:,5))-a_cal(3,1))/a_cal(3,2) + p*a_cal(3,3) + a_cal(3,4)*(s(:,5)-1958.5)/681.5;
ax = ((s(:,3))-a_cal(1,1))/a_cal(1,2) ;
ay = ((s(:,4))-a_cal(2,1))/a_cal(2,2) ;
az = ((s(:,5))-a_cal(3,1))/a_cal(3,2) ;
A = [p t-20 ax ay az]*ax_cal' ;

% 1st value is often bad - replace

A(1,:) = A(2,:) ;

% report on trustworthiness of accelerometer measurements

v = sqrt(decdc(A(k,:),4).^2*[1;1;1]) ;
fprintf('Mean Accelerometer Magnitude: %4.2f g, standard deviation: %4.3f g\n',...
   mean(v), std(v)) ;

% calibrate magnetometers

fprintf('Computing magnetic field signals...\n') ;
mx = ((s(:,7)-m_cal(1,1))/m_cal(1,2)) ; %removed dec4
my = ((s(:,8)-m_cal(2,1))/m_cal(2,2)) ; %removed dec4
mz = ((s(:,9)-m_cal(3,1))/m_cal(3,2)) ; %removed dec4

% remove cross-terms and fix axes

fs = 32e3/680/8 ;
M = [mbb mx my mz]*mx_cal' ;
M = [-M(:,2) -M(:,1) -M(:,3)] ;  % corrects for magnetometer placement in tag (right hand rule) & intensity scale for Belize

% 1st value is often bad - replace

M(1,:) = M(2,:) ;

% report on trustworthiness of magnetometer measurements

v = sqrt(M(k,:).^2*[1;1;1]) ;
mi = mean(v) ;
fprintf('Mean Magnetic Field Intensity: %4.2f uT, standard deviation: %4.2f uT\n',...
   mean(v), std(v)) ;

v = 180/pi*real(acos(sum(A(k,:)'.*M(k,:)')'/mi))-90 ;
fprintf('Mean Magnetic Field Inclination: %4.2f\260, standard deviation: %4.2f\260\n',...
   mean(v), std(v)) ;
